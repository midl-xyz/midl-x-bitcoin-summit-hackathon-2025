<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UTXO Wallet Demo</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .content {
        padding: 30px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        text-align: center;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s ease;
      }

      .transaction-builder {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 200px 150px;
        gap: 15px;
        align-items: end;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .results {
        background: #e8f5e8;
        border: 1px solid #d4edda;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
      }

      .results h3 {
        color: #155724;
        margin-bottom: 15px;
      }

      .result-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .result-item {
        text-align: center;
      }

      .result-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #155724;
      }

      .result-label {
        color: #666;
        font-size: 0.9em;
      }

      .utxo-list {
        background: white;
        border-radius: 6px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
      }

      .utxo-item {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 15px;
        padding: 10px;
        border-bottom: 1px solid #eee;
        align-items: center;
      }

      .utxo-item:last-child {
        border-bottom: none;
      }

      .outpoint {
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        color: #666;
      }

      .value {
        font-weight: bold;
        color: #333;
      }

      .confirmations {
        background: #667eea;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
      }

      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* PSBT Builder Styles */
      .psbt-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border-left: 4px solid #007bff;
      }

      .psbt-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      .psbt-item {
        text-align: center;
        padding: 10px;
      }

      .output-section {
        margin-top: 20px;
      }

      .output-form {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 15px;
        align-items: end;
        margin-bottom: 20px;
      }

      .output-form input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .create-psbt-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .create-psbt-btn:hover {
        background: #218838;
      }

      #psbt-result {
        margin-top: 20px;
        padding: 15px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }

      #psbt-data {
        width: 100%;
        font-family: "Courier New", monospace;
        font-size: 12px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f8f9fa;
        resize: vertical;
      }

      .psbt-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      .psbt-actions button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .psbt-actions button:hover {
        background: #0056b3;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .result-summary {
          grid-template-columns: 1fr;
        }

        .utxo-item {
          grid-template-columns: 1fr;
          text-align: center;
          gap: 5px;
        }

        .output-form {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .psbt-summary {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🪙 UTXO Wallet Demo</h1>
        <p>Bitcoin UTXO Indexer-Selector Frontend Integration</p>
      </div>

      <div class="content">
        <!-- Stats Section -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-utxos">-</div>
            <div class="stat-label">Total UTXOs</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-value">-</div>
            <div class="stat-label">Total Value (BTC)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="current-height">-</div>
            <div class="stat-label">Current Block</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="sync-progress">-</div>
            <div class="stat-label">Sync Progress</div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progress-fill"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>

        <!-- Transaction Builder -->
        <div class="transaction-builder">
          <h2>🔨 Create Transaction</h2>
          <p style="margin-bottom: 20px; color: #666">
            Select UTXOs for your Bitcoin transaction using different
            algorithms.
          </p>

          <div class="form-row">
            <div class="form-group">
              <label for="target-amount">Amount (BTC)</label>
              <input
                type="number"
                id="target-amount"
                step="0.00000001"
                placeholder="0.00000000"
              />
            </div>
            <div class="form-group">
              <label for="strategy">Selection Strategy</label>
              <select id="strategy">
                <option value="largest_first">Largest First</option>
                <option value="smallest_first">Smallest First</option>
                <option value="branch_and_bound">Branch & Bound</option>
                <option value="oldest_first">Oldest First</option>
                <option value="newest_first">Newest First</option>
                <option value="effective_value">
                  Effective Value (Fee Optimized)
                </option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn" id="select-btn" onclick="selectUtxos()">
                Select UTXOs
              </button>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div id="results" style="display: none"></div>

        <!-- PSBT Builder Section -->
        <div id="psbt-builder" style="display: none"></div>
        <div id="error" style="display: none"></div>
        <div id="loading" style="display: none" class="loading">
          <div class="spinner"></div>
          Loading...
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3030";

      // Utility functions
      function formatBTC(sats) {
        return (sats / 100000000).toFixed(8);
      }

      function formatNumber(num) {
        return num.toLocaleString();
      }

      function formatStrategyName(strategy) {
        const strategyNames = {
          largest_first: "LARGEST FIRST",
          smallest_first: "SMALLEST FIRST",
          branch_and_bound: "BRANCH & BOUND",
          oldest_first: "OLDEST FIRST",
          newest_first: "NEWEST FIRST",
          effective_value: "EFFECTIVE VALUE (FEE OPTIMIZED)",
        };
        return (
          strategyNames[strategy] || strategy.replace("_", " ").toUpperCase()
        );
      }

      function showLoading(show = true) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.innerHTML = `<div class="error">❌ ${message}</div>`;
        errorDiv.style.display = "block";
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      // API functions
      async function apiCall(endpoint, options = {}) {
        try {
          const response = await fetch(`${API_BASE}${endpoint}`, {
            headers: {
              "Content-Type": "application/json",
              ...options.headers,
            },
            ...options,
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "API request failed");
          }

          return result.data;
        } catch (error) {
          console.error("API Error:", error);
          throw error;
        }
      }

      async function fetchStats() {
        try {
          const stats = await apiCall("/stats");
          updateStatsDisplay(stats);
          hideError();
        } catch (error) {
          showError(`Failed to fetch stats: ${error.message}`);
        }
      }

      function updateStatsDisplay(stats) {
        document.getElementById("total-utxos").textContent = formatNumber(
          stats.total_utxos
        );
        document.getElementById("total-value").textContent = formatBTC(
          stats.total_value
        );
        document.getElementById("current-height").textContent = formatNumber(
          stats.current_height
        );
        document.getElementById(
          "sync-progress"
        ).textContent = `${stats.progress_percent.toFixed(1)}%`;
        document.getElementById(
          "progress-fill"
        ).style.width = `${stats.progress_percent}%`;
      }

      async function selectUtxos() {
        const targetAmount = document.getElementById("target-amount").value;
        const strategy = document.getElementById("strategy").value;

        if (!targetAmount || parseFloat(targetAmount) <= 0) {
          showError("Please enter a valid amount");
          return;
        }

        try {
          showLoading(true);
          hideError();
          document.getElementById("results").style.display = "none";

          const amountSats = Math.floor(parseFloat(targetAmount) * 100000000);

          // Prepare selection request
          const requestBody = {
            target_amount: amountSats,
            strategy: strategy,
            max_utxos: 20,
          };

          // Add fee parameters for effective_value strategy
          if (strategy === "effective_value") {
            requestBody.fee_rate_sat_per_vbyte = 10.0; // Default fee rate
            requestBody.output_count = 2; // Assume 1 output + 1 change
          }

          const selection = await apiCall("/select", {
            method: "POST",
            body: JSON.stringify(requestBody),
          });

          displayResults(selection);
        } catch (error) {
          showError(`Selection failed: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      function displayResults(selection) {
        const resultsDiv = document.getElementById("results");

        const html = `
                <div class="results">
                    <h3>✅ Selection Results</h3>
                    
                    <div class="result-summary">
                        <div class="result-item">
                            <div class="result-value">${
                              selection.utxos.length
                            }</div>
                            <div class="result-label">UTXOs Selected</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${formatBTC(
                              selection.total_amount
                            )}</div>
                            <div class="result-label">Total Amount (BTC)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${formatBTC(
                              selection.change_amount
                            )}</div>
                            <div class="result-label">Change (BTC)</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${formatStrategyName(
                              selection.strategy
                            )}</div>
                            <div class="result-label">Strategy Used</div>
                        </div>
                    </div>
                    
                    <div class="utxo-list">
                        <h4>Selected UTXOs:</h4>
                        ${selection.utxos
                          .slice(0, 10)
                          .map(
                            (utxo) => `
                            <div class="utxo-item">
                                <div class="outpoint">${utxo.outpoint}</div>
                                <div class="value">${formatBTC(
                                  utxo.output.value
                                )} BTC</div>
                                <div class="confirmations">${
                                  utxo.confirmations
                                } conf</div>
                            </div>
                        `
                          )
                          .join("")}
                        ${
                          selection.utxos.length > 10
                            ? `
                            <div style="text-align: center; padding: 10px; color: #666;">
                                ... and ${
                                  selection.utxos.length - 10
                                } more UTXOs
                            </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;

        resultsDiv.innerHTML = html;
        resultsDiv.style.display = "block";

        // Store selection for PSBT creation
        window.currentSelection = selection;
        updatePsbtBuilder(selection);
      }

      function updatePsbtBuilder(selection) {
        const psbtDiv = document.getElementById("psbt-builder");
        if (!psbtDiv) return;

        const html = `
          <div class="psbt-section">
            <h3>🔧 PSBT Builder</h3>
            
            <div class="psbt-summary">
              <div class="psbt-item">
                <strong>Selected UTXOs:</strong> ${selection.utxos.length}
              </div>
              <div class="psbt-item">
                <strong>Total:</strong> ${formatBTC(selection.total_amount)} BTC
              </div>
                              <div class="psbt-item">
                  <strong>Strategy:</strong> ${formatStrategyName(
                    selection.strategy
                  )}
                </div>
              <div class="psbt-item">
                <strong>Change:</strong> ${formatBTC(
                  selection.change_amount
                )} BTC
              </div>
            </div>
            
            <div class="output-section">
              <h4>Outputs</h4>
              <div class="output-form">
                <input type="text" id="output-address" placeholder="Recipient Address" value="bcrt1qcjq0a9a0ytjvudqp6amzmx32avhushp7z9984n">
                <input type="number" id="output-amount" placeholder="Amount (BTC)" step="0.00000001" value="${
                  (selection.total_amount - selection.change_amount) / 100000000
                }">
                <input type="number" id="fee-rate" placeholder="Fee Rate (sat/vB)" value="1" min="1">
                <button onclick="createPsbt()" class="create-psbt-btn">Create PSBT</button>
              </div>
            </div>
            
            <div id="psbt-result" style="display: none;">
              <h4>PSBT Created</h4>
              <textarea id="psbt-data" readonly rows="10" cols="80"></textarea>
              <div class="psbt-actions">
                <button onclick="copyPsbt()">Copy PSBT</button>
                <button onclick="downloadPsbt()">Download PSBT</button>
              </div>
            </div>
          </div>
        `;

        psbtDiv.innerHTML = html;
        psbtDiv.style.display = "block";
      }

      async function createPsbt() {
        if (!window.currentSelection) {
          showError("No UTXOs selected. Please select UTXOs first.");
          return;
        }

        const outputAddress = document.getElementById("output-address").value;
        const outputAmount = parseFloat(
          document.getElementById("output-amount").value
        );
        const feeRate = parseInt(document.getElementById("fee-rate").value);

        if (!outputAddress || !outputAmount || !feeRate) {
          showError("Please fill in all PSBT fields");
          return;
        }

        try {
          // Convert amount to satoshis
          const outputAmountSats = Math.floor(outputAmount * 100000000);

          // Create PSBT data structure
          const psbtData = {
            inputs: window.currentSelection.utxos.map((utxo) => ({
              hash: utxo.outpoint.split(":")[0],
              index: parseInt(utxo.outpoint.split(":")[1]),
              witnessUtxo: {
                script: new Uint8Array(
                  utxo.output.script_pubkey.data || utxo.output.script_pubkey
                ),
                value: BigInt(utxo.output.value),
              },
            })),
            outputs: [
              {
                address: outputAddress,
                value: BigInt(outputAmountSats),
              },
            ],
            feeRate: feeRate,
          };

          // For demo purposes, create a simple PSBT representation
          const psbtJson = {
            version: 2,
            inputs: psbtData.inputs.map((input) => ({
              hash: input.hash,
              index: input.index,
              witnessUtxo: {
                script: Array.from(input.witnessUtxo.script),
                value: input.witnessUtxo.value.toString(),
              },
            })),
            outputs: psbtData.outputs.map((output) => ({
              address: output.address,
              value: output.value.toString(),
            })),
            fee_rate: feeRate,
          };

          // Display the PSBT
          document.getElementById("psbt-data").value = JSON.stringify(
            psbtJson,
            null,
            2
          );
          document.getElementById("psbt-result").style.display = "block";

          hideError();
          console.log("✅ PSBT created successfully");
        } catch (error) {
          console.error("PSBT creation error:", error);
          showError(`Failed to create PSBT: ${error.message}`);
        }
      }

      function copyPsbt() {
        const psbtData = document.getElementById("psbt-data");
        psbtData.select();
        document.execCommand("copy");

        // Show feedback
        const originalText = psbtData.value;
        psbtData.value = "✅ PSBT copied to clipboard!";
        setTimeout(() => {
          psbtData.value = originalText;
        }, 2000);
      }

      function downloadPsbt() {
        const psbtData = document.getElementById("psbt-data").value;
        const blob = new Blob([psbtData], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "transaction.psbt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Initialize the app
      async function init() {
        console.log("🚀 Initializing UTXO Wallet Demo...");

        try {
          // Check if API is available
          await apiCall("/health");
          console.log("✅ API connection successful");

          // Load initial stats
          await fetchStats();

          // Set up auto-refresh
          setInterval(fetchStats, 30000);

          console.log("✅ Demo initialized successfully");
        } catch (error) {
          showError(
            `Failed to connect to UTXO Indexer API. Make sure it's running on ${API_BASE}`
          );
          console.error("❌ Initialization failed:", error);
        }
      }

      // Start the app
      document.addEventListener("DOMContentLoaded", init);

      // Handle Enter key in amount input
      document
        .getElementById("target-amount")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            selectUtxos();
          }
        });
    </script>
  </body>
</html>
